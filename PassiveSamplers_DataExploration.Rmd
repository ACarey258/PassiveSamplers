---
title: "2017 Nisqually Passive Sampler Study"
output: html_notebook
---

```{r}
# First step, clear workspace to make sure every thing will work, rm means remove
rm(list=ls(all=TRUE))

# load required packages/libraries
library(readxl)
library(tidyverse)
library(stats)
library(ggrepel)

#set data path
paths = list("C:\\data\\GitHub\\PassiveSamplers\\2017NQPassiveSamplers_Data.xlsx",
             "C:\\data\\GitHub\\PassiveSamplers\\Outfiles\\")

#set outfile
outfile = paths[[2]]

#read in data
Sthd <- read_excel(paths[[1]],"Steelhead")
```

reshape() Steelhead dataframe to long format to set up for a loop.
```{r}
colnames(Sthd)
LongSthd <- Sthd %>%
  gather(Variable, Value, 9:20)
```
Scatterplots comparing stable isotopes to PBDEs, etc
```{r}
Sthd$Year <- as.factor(Sthd$Year) #set year as a factor so it can be used as a categorical variable

```

STABLE ISOTOPE = d15N
Sum11PBDEs (ng/g ww) compared with d15N
```{r}
ggplot(data = Sthd, mapping = aes(x = d15N_UW, y = Sum11PBDEs)) +
  geom_point(mapping = aes(color = Year), size = 2, shape = 1) +
  geom_smooth(method = lm, se = TRUE, level = 0.95) +
  geom_text(aes(label = ifelse(Sum11PBDEs > 6.5, #only labels points above a certain threshold
                               as.character(SampleID),
                               ' ')),
            hjust = 0,
            vjust = 0)
```
2014 samples have a different d15N signal than 2015 samples (with one exception).

2013 would have been a pink year so pink fry would have been in the system in spring 2014 - are the Steelhead smolts feeding on them and gaining a different d15N signature? 


PBDEs/g lipids compared with d15N
```{r}
Sthd$lab1 <- ifelse(Sthd$PBDEsLipNorm > 850, Sthd$SampleID,"")

ggplot(data = Sthd, mapping = aes(x = d15N_UW, y = PBDEsLipNorm)) +
  geom_point(mapping = aes(color = Year), size = 2, shape = 1) +
  geom_smooth(method = lm, se = TRUE, level = 0.95) +
  geom_label_repel(aes(label = Sthd$lab1, #only labels points w/PBDEsLipNorm >850
                    fill = factor(Year)), color = 'black',
                    size = 3.5)
  
  #geom_text(aes(label = ifelse(PBDEsLipNorm > 850, #only labels points above a certain threshold
                               #as.character(SampleID),
                               #' ')),
            #hjust = 1, #horizontal justification 0.5 will center it, 1 is left, 0 is right
            #vjust = 0) #vertical justification, 0 is above and 1 is below
```
A method to "repel" the labels so they don't overlap.
LABELS ALL POINTS but they're all readable
```{r}
ggplot(data = Sthd, mapping = aes(x = d15N_UW, y = PBDEsLipNorm)) +
  geom_point(mapping = aes(color = Year), size = 2, shape = 1) +
  geom_smooth(method = lm, se = TRUE, level = 0.95) +
  geom_label_repel(aes(label = SampleID),
                   box.padding = 0.35,
                   point.padding = 0.5,
                   segment.color = 'grey50') 
```

Sum PBDEs 47 + 99 compared with d15N
```{r}
colnames(Sthd)

ggplot(data = Sthd, mapping = aes(x = d15N_UW, y = Sum47n99)) +
  geom_point(mapping = aes(color = Year), size = 2, shape = 1) +
  geom_smooth(method = lm, se = TRUE, level = 0.95) +
  geom_text(aes(label = ifelse(Sum47n99 > 5, #only labels points above a certain threshold
                               as.character(SampleID),
                               ' ')),
            hjust = 0,
            vjust = 0)
```
Add a column with the ratio of PCBs to PBDEs
Plot PCBs/PBDEs compared with d15N
```{r}
Sthd <- mutate(Sthd,
               ratio = TPCBs / Sum11PBDEs)
Sthd$lab2 <- ifelse(Sthd$ratio > 3, Sthd$SampleID, "")

ggplot(data = Sthd, mapping = aes(x = d15N_UW, y = ratio)) +
  geom_point(mapping = aes(color = Year), size = 2, shape = 1) +
  geom_smooth(method = lm, se = TRUE, level = 0.95) +
  geom_label_repel(aes(label = Sthd$lab2, #only labels points w/PBDEsLipNorm >900
                    fill = factor(Year)), color = 'black',
                    size = 3.5)
#USE THIS CODE FIRST TO DETERMINE THRESHOLD FOR LABELS  
  #geom_text(aes(label = ifelse(ratio > 3, #only labels points above a certain threshold
                               #as.character(SampleID),
                              #' ')),
            #hjust = 0,
            #vjust = 0)

```

One sample, Fish #147506 had a very high PCBs/PBDEs ratio as well as a high d15N value of 13.22.79.  That fish was analyzed with the 2015 samples but it was collected at the trap in 2014.  Its larger than all the other Steelhead we processed with a weight of 812g and a FL of 460 mm but it was aged as a two year old. There are 21 - two year olds and 1 - three year old.

STABLE ISOTOPE = d13C
Sum11PBDEs (ng/g ww) compared with d13C
```{r}
Sthd$lab3 <- ifelse(Sthd$Sum11PBDEs > 9, Sthd$SampleID, "")

ggplot(data = Sthd, mapping = aes(x = d13C_UW, y = Sum11PBDEs)) +
  geom_point(mapping = aes(color = Year), size = 2, shape = 1) +
  geom_smooth(method = lm, se = TRUE, level = 0.95) +
  geom_label_repel(aes(label = Sthd$lab3, #only labels points w/Sum11PBDEs >9
                    fill = factor(Year)), color = 'black',
                    size = 3.5)
  #geom_text(aes(label = ifelse(Sum11PBDEs > 9, #only labels points above a certain threshold
                               #as.character(SampleID),
                               #' ')),
            #hjust = 1,
            #vjust = 0)
```

PBDEs/g lipids compared with d13C
```{r}
Sthd$lab4 <- ifelse(Sthd$PBDEsLipNorm > 950, Sthd$SampleID, "")

ggplot(data = Sthd, mapping = aes(x = d13C_UW, y = PBDEsLipNorm)) +
  geom_point(mapping = aes(color = Year), size = 2, shape = 1) +
  geom_smooth(method = lm, se = TRUE, level = 0.95) +
  geom_label_repel(aes(label = Sthd$lab4, #only labels points w/PBDEsLipNorm >950
                    fill = factor(Year)), color = 'black',
                    size = 3.5)
  
  #geom_text(aes(label = ifelse(PBDEsLipNorm > 1000, 
                               #as.character(SampleID),
                               #' ')),
            #hjust = 0,
            #vjust = 0)
```

Sum PBDEs 47 + 99 compared with d13C
```{r}
ggplot(data = Sthd, mapping = aes(x = d13C_UW, y = Sum47n99)) +
  geom_point(mapping = aes(color = Year), size = 2, shape = 1) +
  geom_smooth(method = lm, se = TRUE, level = 0.95) +
  geom_text(aes(label = ifelse(Sum47n99 > 6, #only labels points above a certain threshold
                               as.character(SampleID),
                               ' ')),
            hjust = 1,
            vjust = 0)
```

PCBs/PBDEs compared with d13C
```{r}
Sthd$lab5 <- ifelse(Sthd$ratio > 3, Sthd$SampleID, "")

ggplot(data = Sthd, mapping = aes(x = d13C_UW, y = ratio)) +
  geom_point(mapping = aes(color = Year), size = 2, shape = 1) +
  geom_smooth(method = lm, se = TRUE, level = 0.95) +
  geom_label_repel(aes(label = Sthd$lab5, #only labels points w/PCBs/PBDEs ratio >3
                    fill = factor(Year)), color = 'black',
                    size = 3.5)
  
  #geom_text(aes(label = ifelse(ratio > 3, #only labels points above a certain threshold
                               #as.character(SampleID),
                               #' ')),
            #hjust = 0,
            #vjust = 0)

```

ADDING REGRESSION EQUATION AND R^2 to a figure
```{r}
Sthd$labyn <- ifelse(Sthd$PBDEsLipNorm > 900, Sthd$SampleID, "") #adds a new "dummy" column containing only SampleIDs with PBDEsLipNorm > 900 gPBDEs/g lipid

# calculate regression equation and r^2 
lm_eqn <- function(Sthd){
  m <- lm(PBDEsLipNorm ~ d15N_UW, Sthd);
  eq <- substitute(italic(y) == a + b %.% italic(r)^2 ~ "=" ~ r2,
                   list(a = format(coef(m)[1], digits = 2),
                        b = format(coef(m)[2], digits = 2),
                        r2 = format(summary(m)$r.squared, digits = 3)))
  as.character(as.expression(eq));
}

ggplot(data = Sthd, mapping = aes(x = d15N_UW, y = PBDEsLipNorm)) +
  geom_point(mapping = aes(color = Year), size = 2, shape = 1) +
  geom_smooth(method = lm, se = TRUE, level = 0.95) +
  #geom_label_repel(aes(label = Sthd$labyn, #only labels points w/PBDEsLipNorm >900
                    #fill = factor(Year)), color = 'black',
                    #size = 3.5) +
  guides(fill = FALSE) +
  theme_bw() +
  xlab(expression(delta*"15N")) +
  ylab(expression(Sigma*"11PBDEs/g lipid")) +
  geom_text(x = 7, y = 2500, label = lm_eqn(Sthd), parse = TRUE) #adds regression equation and r^2 to figure
```

Create a bar chart of the PBDEs measured in the SPMDs and biofilm

TPBDEs in Biofilm (parts per trillion)

```{r}
BioSPMD <- read_excel(paths[[1]],"BiofilmSPMDs")
colnames(BioSPMD)
BioSPMD$SiteID <- factor(BioSPMD$SiteID, levels = c("11NR3.75", "11MC0.25", "11NR12.25", "11CC0.25", "11NR12.5", "11NR10.0",
                                                       "11NR26.25", "11OVC0.1", "11MR0.5", "11MR0.5 dup", "11MR4.9", "11NR39.75"))

ggplot(BioSPMD, mapping = aes(x = SiteID, y = biofilm_ppt)) +
  geom_bar(position = position_dodge(), fill = "#56B4E9", colour = "black", stat = "identity") +
  guides(fill = FALSE) +
  labs(x = "Site",
       y = "TPBDEs in biofilm (ppt)") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.9, vjust = 0.95, size = 12)) 


```

TPBDEs in Biofilm AND SPMDs
```{r}
PPT <- read_excel(paths[[1]],"PassSampPPT")
colnames(PPT)
PPT$SiteID <- factor(PPT$SiteID, levels = c("11NR3.75", "11MC0.25", "11NR12.25", "11CC0.25", "11NR12.5", "11NR10.0",
                                                       "11NR26.25", "11OVC0.1", "11MR0.5", "11MR0.5 dup", "11MR4.9", "11NR39.75"))

##ERROR

ggplot(data = PPT, aes(x = SiteID, y = TPBDEs_ppt)) +
  geom_bar(mapping = aes(fill = Matrix, position = "dodge"), stat = "identity") +
   labs(x = "Site",
       y = "TPBDEs (ppt)") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.9, vjust = 0.95, size = 12)) 
```

